<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Santa Maria Novella</title>

	<link rel="stylesheet" type="text/css" href="../../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../../libs/jstree/themes/mixed/style.css">
</head>

<body>
	<script src="../../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../../libs/spectrum/spectrum.js"></script>
	<script src="../../libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="../../libs/other/BinaryHeap.js"></script>
	<script src="../../libs/tween/tween.min.js"></script>
	<script src="../../libs/d3/d3.js"></script>
	<script src="../../libs/proj4/proj4.js"></script>
	<script src="../../libs/openlayers3/ol.js"></script>
	<script src="../../libs/i18next/i18next.js"></script>
	<script src="../../libs/jstree/jstree.js"></script>
	<script src="../../build/potree/potree.js"></script>
	<script src="../../libs/plasio/js/laslaz.js"></script>
	
	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
	<!-- INCLUDE SETTINGS HERE -->
	
	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area" style="background-image: url('../../build/potree/resources/images/background.jpg');"></div>
		<div id="potree_sidebar_container"> </div>
	</div>
	
	<script type="module">
		import * as THREE from "../../libs/three.js/build/three.module.js";
	
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

		viewer.useHQ = true; 
		viewer.setEDLEnabled(false);
		viewer.setFOV(60);
		viewer.setPointBudget(6 * 1000 * 1000);
        viewer.loadSettingsFromURL();
        viewer.scene.view.position.set(-102.663, -39.083, 14.195);
        viewer.scene.view.lookAt(-78.271, -22.381, 7.998);

		
		viewer.loadSettingsFromURL();
		
		viewer.setDescription("");
		viewer.scene.camera;
		viewer.setDescription("Point cloud by <a target='_blank' href='https://florenceasitwas.wlu.edu/'>Florence As It Was</a>");
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_appearance").next().show();
			$("#menu_tools").next().show();
			$("#menu_clipping").next().show();
			viewer.toggleSidebar();
		});
		
		

		Potree.loadPointCloud("../../pointclouds/SMN/SMN20241115/metadata.json", "SMN", e => {
			let scene = viewer.scene;
			let pointcloud = e.pointcloud;

            scene.addPointCloud(pointcloud);
			let material = pointcloud.material;
			material.size = 1;
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
			material.shape = Potree.PointShape.SQUARE;
			material.activeAttributeName = "rgba";
			material.uniforms.uShadowColor.value = [0.6, 0.6, 0.6];

     
           
            

			
		});

        Potree.loadPointCloud("../../pointclouds/SMN/smndv1600church/metadata.json", "DV Church", e => {
			let scene = viewer.scene;
			let pointcloud = e.pointcloud;

            scene.addPointCloud(pointcloud);
			let material = pointcloud.material;
			material.size = .05;
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
			material.shape = Potree.PointShape.SQUARE;
			material.activeAttributeName = "matcap";
			//material.activeAttributeName =
			e.pointcloud.position.set(20.6,1.3,-.5);
           
            

			
		});

		Potree.loadPointCloud("../../pointclouds/SMN/smndv1600crypt/metadata.json", "DV Crypt", e => {
			let scene = viewer.scene;
			let pointcloud = e.pointcloud;

            scene.addPointCloud(pointcloud);
			let material = pointcloud.material;
			material.size = .05;
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
			material.shape = Potree.PointShape.SQUARE;
			material.activeAttributeName = "matcap";
			//material.activeAttributeName =
			e.pointcloud.position.set(17.7,17.5,-3.94);
           
            

			
		});
		
        const animation = new Potree.CameraAnimation(viewer);


const positions = [
   [-15.510, 77.259, 31.519],
   [-25.246, 44.726, 36.230],
   [-30.476, 23.342, 38.955],
   [-29.325, 5.861, 37.994],
   [-22.877, -17.661, 33.381],
   [-1.049, -31.259, 29.784],
   [18.932, -41.011, 29.084],
   [51.360, -42.563, 28.311],
   [73.216, -22.604, 26.720],
   [88.488, 4.338, 28.260],
   [88.522, 29.388, 27.435],
   [84.357, 47.871, 25.255],
   [72.210, 67.531, 20.222],
   [62.535, 76.694, 22.261],
   [25.807, 94.000, 26.118],
   [-7.212, 81.209, 24.170],
   [-17.007, 44.058, 5.935],
   [-14.962, 27.300, 2.933],
   [-12.813, 15.974, 1.770],
   [-7.198, 8.743, 2.864],
   [-1.928, -2.016, 3.207],
   [8.520, -12.709, 4.054],
   [23.989, -18.271, 5.643],
   [39.276, -18.703, 5.759],
   [54.805, -11.291, 6.261],
   [65.300, 5.543, 1.296],
   [67.938, 24.523, 0.480],
   [68.323, 48.618, 1.081],
   [58.561, 64.523, 3.632],
   [45.025, 66.048, 5.841],
   [35.072, 66.335, 7.048],
   [22.489, 64.432, 6.417],
   [9.755, 57.737, 3.318],


];

const targets = [
    [17.995, 40.498, 9.016],
	[8.057, 26.869, 13.263],
	[9.971, 18.644, 21.710],
	[7.639, 15.608, 15.765],
	[8.902, 5.722, 13.414],
	[16.434, 0.417, 13.203],
	[23.162, -4.534, 13.741],
	[39.667, -6.877, 15.130],
	[52.999, -0.163, 15.456],
	[59.047, 10.832, 16.849],
	[58.217, 25.375, 17.202],
	[57.317, 32.480, 16.818],
	[45.409, 46.030, 12.943],
	[42.956, 48.075, 12.375],
	[32.067, 53.923, 10.810],
	[17.852, 52.260, 6.460],
	[5.124, 41.025, -1.300],
	[0.188, 34.521, 0.240],
	[7.377, 19.104, 0.888],
	[8.301, 15.053, 3.609],
	[11.107, 9.547, 4.582],
	[14.911, 6.266, 5.451],
	[20.433, 5.615, 5.738],
	[24.028, 7.834, 4.359],
	[30.175, 10.871, 3.873],
	[40.359, 21.161, 4.183],
	[42.982, 24.438, 4.123],
	[47.530, 38.387, 5.233],
	[46.760, 43.289, 6.236],
	[40.506, 47.496, 5.199],
	[34.062, 51.594, 4.869],
	[28.902, 52.603, 4.869],
	[18.067, 48.208, 3.149],
	
   
];

for(let i = 0; i < positions.length; i++){
    const cp = animation.createControlPoint();

    cp.position.set(...positions[i]);
    cp.target.set(...targets[i]);
}

viewer.scene.addCameraAnimation(animation);






		{
            let pageTitle, location, blockName, annotationDetails, cameraPosition, cameraTarget = '';
            const annoData = [];
            const url = 'annotationSMN.txt?v=2';
            fetch(url)
              .then((res) => res.text())
              .then((text) => {
                const sections = text.split(/\\\\+/); 

                sections.forEach(section => {
                  const lines = section.split('\n');

                  
                  pageTitle = location = blockName = annotationDetails = cameraPosition = cameraTarget = '';

                  // Parse each line
                  lines.forEach(line => {
                    if (line.startsWith('Page:')) {
                      pageTitle = line.replace('Page:', '').trim();
                    } else if (line.startsWith('Location of Annotation:')) {
                      location = line.replace('Location of Annotation:', '').trim();
                    } else if (line.startsWith('Camera Location:')) {
                      cameraPosition = line.replace('Camera Location:', '').trim();
                    } else if (line.startsWith('Camera Looks Towards:')) {
                      cameraTarget = line.replace('Camera Looks Towards:', '').trim();
                    } else if (line.startsWith('Annotation block name:')) {
                      blockName = line.replace('Annotation block name:', '').trim();
                    } else if (line.startsWith('Annotation Details:')) {
                      annotationDetails = line.replace('Annotation Details:', '').trim();
                    } else {
                      // If it's not a key line, add to annotation details
                      if (annotationDetails) {
                        annotationDetails += `<p>${line.trim()}</p>`;
                      }
                    }
                  });
                  // Check if we have a valid title and location
                  if (pageTitle && location) {

                    location = location.split(",").map(value => parseFloat(value.trim()));
                    cameraPosition = cameraPosition.split(",").map(value => parseFloat(value.trim()));
                    cameraTarget = cameraTarget.split(",").map(value => parseFloat(value.trim()));

                    const currentUrl = window.location.href;


                    // Only process if the current URL matches the page title
                    if (currentUrl === pageTitle) {
                      processData(pageTitle, location, cameraPosition, cameraTarget, blockName, annotationDetails);
                    }
                  }
                });
              })
              .catch((e) => console.error(e));

            function processData(title) {
                let autoAnnos = new Potree.Annotation({
                    position: location,
                    "cameraPosition": cameraPosition,
                    "cameraTarget": cameraTarget,
                    "title": blockName,
                    "description": annotationDetails
                });
                viewer.scene.annotations.add(autoAnnos);
            }	
        }
		
		//end annnotation
		
		var supportsWheel = false;
		var annotations =  viewer.scene.getAnnotations(); 
		const MinDistanceFromPainting = 50;
		
		/* The function that will run when the events are triggered. */
		function HideAnnotations (e) {
			/* Check whether the wheel event is supported. */
			if (e.type == "wheel") supportsWheel = true;
			else if (e.key === 'w' || e.key === 'a' || e.key === 's' || e.key === 'd') supportsWheel =  true;
			else if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') supportsWheel =  true;
			else if (supportsWheel) return;
				
	
			if (annotations && annotations.children) {
					annotations.children.forEach(function(anno) {
					if (anno.position) {
						if (anno.title) {

							if (Math.sqrt(((viewer.scene.getActiveCamera().position.x) - (anno.position.x))**2  +
									      ((viewer.scene.getActiveCamera().position.y) - (anno.position.y))**2 +
										  ((viewer.scene.getActiveCamera().position.z) - (anno.position.z))**2) < MinDistanceFromPainting) {
								anno.visible = true;
							} else {
								anno.visible = false;
							}
						}
					}
				});
			}
				
				
		}
		/* Add the event listeners for each event. */
		document.addEventListener('wheel', HideAnnotations);
		document.addEventListener('keydown', HideAnnotations);
		document.addEventListener('DOMMouseScroll', HideAnnotations);
		
		
	</script>
	
	
  </body>
</html>
