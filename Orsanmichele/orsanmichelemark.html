<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Orsanmichele pointcloud</title>
	<!-- These style sheets control the look and feel of the potree web interface. 
	These can be edited to customize the look -->
	<link rel="stylesheet" type="text/css" href="../../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../../libs/jstree/themes/mixed/style.css">
</head>

<body>
	<!-- INCLUDE DEPENDENCIES HERE. these are all publicly available open-source libraries. 
	These are all included in the standard Potree install -->
	<script src="../../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../../libs/spectrum/spectrum.js"></script>
	<script src="../../libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="../../libs/other/BinaryHeap.js"></script>
	<script src="../../libs/tween/tween.min.js"></script>
	<script src="../../libs/d3/d3.js"></script>
	<script src="../../libs/proj4/proj4.js"></script>
	<script src="../../libs/openlayers3/ol.js"></script>
	<script src="../../libs/i18next/i18next.js"></script>
	<script src="../../libs/jstree/jstree.js"></script>
	<script src="../../build/potree/potree.js"></script>
	<script src="../../libs/plasio/js/laslaz.js"></script>
	
	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
	<!-- INCLUDE SETTINGS HERE -->
	
	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area" style="background-image: url('../../build/potree/resources/images/background.jpg');"></div>
		<div id="potree_sidebar_container"> </div>
	</div>
	
	<script type="module">
		//these are loaders for mesh object. Usually we will be using .obj files
		import * as THREE from "../../libs/three.js/build/three.module.js";
		import {PLYLoader} from "../../libs/three.js/loaders/PLYLoader.js";
		import {OBJLoader} from "../../libs/three.js/loaders/OBJLoader.js";
	
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
		
		//set default quality setting here. these parameters can be adjusted by the user but default values are set here.
        viewer.useHQ = true;
		viewer.setEDLEnabled(false);
		viewer.setFOV(60);
		viewer.setPointBudget(6_000_000);
		viewer.loadSettingsFromURL();
		
//		viewer.setDescription("Point cloud by <a target='_blank' href='https://florenceasitwas.wlu.edu/'>Florence As It Was</a><br><audio controls loop><source src='../../build/potree/resources/music/Orsanmichele Ambient Sounds.wav' type='audio/mpeg'></audio>");
		
		viewer.setDescription(`<p></p>Point cloud by <a target='_blank' href='https://florenceasitwas.wlu.edu/'>Florence As It Was</a><br>
		  <audio controls loop style="transform: scale(80%);">
			<source src='../../build/potree/resources/music/Orsanmichele Ambient Sounds.wav' type='audio/mpeg'>
		  </audio>
		`);
		
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_tools").next().show();
			$("#menu_scene").next().show();
			//viewer.toggleSidebar();
		});
		
		// Load the point cloud here: 
		// The "loadPointCloud" method points to the file created by the Potree Converter application.
        Potree.loadPointCloud("../../pointclouds/Orsanmichele/orsanmichele20240918/metadata.json", "Orsanmichele", function(e){
			let scene = viewer.scene;
			scene.addPointCloud(e.pointcloud);
			
			let material = e.pointcloud.material;
			material.size = 1;
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

            viewer.scene.view.position.set(-22.887, 51.337, 3.740);
            viewer.scene.view.lookAt(-6.942, 18.521, 3.945);

            //viewer.scene.view.position.set(-87.007, 60.574, 43.438);
            //viewer.scene.view.lookAt(-19.346, 32.004, 10.151);
			
		});
		
        //OBJ Mesh Object Starts Here cosmas and damien
        {
            let manager = new THREE.LoadingManager();
            manager.onProgress = function (item, loaded, total) {
                console.log(item, loaded, total);
            };

            let onProgress = function (xhr) {
                if (xhr.lengthComputable) {
                    let percentComplete = xhr.loaded / xhr.total * 100;
                    console.log(Math.round(percentComplete, 2) + '% downloaded');
                }
            };
            let onError = function (xhr) { };
			//TextureLoader points to the texture created in the photogrammetry workflow
            const texture = new THREE.TextureLoader().load(`${Potree.resourcePath}/textures/Cosmas90trim.jpg`);

            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;

            let loader = new OBJLoader(manager);
			//OBJLoader loads the polygon model created in the photogrammetry workflow
            loader.load(`${Potree.resourcePath}/models/tramezzo.obj`, function (object) {
                object.traverse(function (child) {
                    if (child instanceof THREE.Mesh) {
                        child.material.map = texture;
                    }
                });
                // The code below positions the polygon model in reference to the 
				// point cloud coordinate system. In this case the units are in meters and radians.
				object.position.set(-20.51, 48.064, 3.556);
                object.scale.multiplyScalar(0.01);
                // object.scale.x
                object.rotation.set(Math.PI/2, Math.PI/5.7, 0);


                viewer.scene.scene.add(object);

                viewer.onGUILoaded(() => {
                    // Add entries to object list in sidebar
                    let tree = $(`#jstree_scene`);
                    let parentNode = "other";

                    let meshID = tree.jstree('create_node', parentNode, {
                        text: "Saints Cosmas and Damian",
                        icon: `${Potree.resourcePath}/icons/triangle.svg`,
                        data: object
                    },
                        "last", false, false);
                    tree.jstree(object.visible ? "check_node" : "uncheck_node", meshID);

                    //tree.jstree("open_node", parentNode);
                });

            }, onProgress, onError);
        }
		//Obj Mesh object ends HERE

		//OBJ Mesh Object2 Starts Here Mathew matt2
        // {
        //     let manager = new THREE.LoadingManager();
        //     manager.onProgress = function (item, loaded, total) {
        //         console.log(item, loaded, total);
        //     };

        //     let onProgress = function (xhr) {
        //         if (xhr.lengthComputable) {
        //             let percentComplete = xhr.loaded / xhr.total * 100;
        //             console.log(Math.round(percentComplete, 2) + '% downloaded');
        //         }
        //     };
        //     let onError = function (xhr) { };
		// 	//TextureLoader points to the texture created in the photogrammetry workflow
        //     const texture = new THREE.TextureLoader().load(`${Potree.resourcePath}/textures/matt2.jpg`);

        //     texture.wrapS = THREE.RepeatWrapping;
        //     texture.wrapT = THREE.RepeatWrapping;

        //     let loader = new OBJLoader(manager);
		// 	//OBJLoader loads the polygon model created in the photogrammetry workflow
        //     loader.load(`${Potree.resourcePath}/models/matt2.obj`, function (object) {
        //         object.traverse(function (child) {
        //             if (child instanceof THREE.Mesh) {
        //                 child.material.map = texture;
        //             }
        //         });
        //         // The code below positions the polygon model in reference to the 
		// 		// point cloud coordinate system. In this case the units are in meters and radians.
		// 		object.position.set(-20.46, 39.49, 3.9);
		// 		object.scale.multiplyScalar(.35);
		// 		object.rotation.set(0, 0, 3.66);


        //         viewer.scene.scene.add(object);

        //         viewer.onGUILoaded(() => {
        //             // Add entries to object list in sidebar
        //             let tree = $(`#jstree_scene`);
        //             let parentNode = "other";

        //             let meshID = tree.jstree('create_node', parentNode, {
        //                 text: "Matthew Triptych",
        //                 icon: `${Potree.resourcePath}/icons/triangle.svg`,
        //                 data: object
        //             },
        //                 "last", false, false);
        //             tree.jstree(object.visible ? "check_node" : "uncheck_node", meshID);

        //             //tree.jstree("open_node", parentNode);
        //         });
        //         viewer.scene.addAnnotation([-20.454, 39.503, 2.006], {
		// 				    "cameraPosition": [-24.377, 43.574, 3.500],
		// 				    "cameraTarget": [-21.488, 38.034, 3.682],
		// 				    "title": "Matthews Triptych",
        //                     "description":"descriptive text here",
		// 		});
        //     }, onProgress, onError);
        // }
		// //Obj Mesh object ends HERE

		// //OBJ Mesh Object2 Starts Here john the Evangelist  
        // {
        //     let manager = new THREE.LoadingManager();
        //     manager.onProgress = function (item, loaded, total) {
        //         console.log(item, loaded, total);
        //     };

        //     let onProgress = function (xhr) {
        //         if (xhr.lengthComputable) {
        //             let percentComplete = xhr.loaded / xhr.total * 100;
        //             console.log(Math.round(percentComplete, 2) + '% downloaded');
        //         }
        //     };
        //     let onError = function (xhr) { };
		// 	//TextureLoader points to the texture created in the photogrammetry workflow
        //     const texture = new THREE.TextureLoader().load(`${Potree.resourcePath}/textures/john_the_evangelist_OSM.jpg`);

        //     texture.wrapS = THREE.RepeatWrapping;
        //     texture.wrapT = THREE.RepeatWrapping;

        //     let loader = new OBJLoader(manager);
		// 	//OBJLoader loads the polygon model created in the photogrammetry workflow
        //     loader.load(`${Potree.resourcePath}/models/john_the_evangelist_OSM2.obj`, function (object) {
        //         object.traverse(function (child) {
        //             if (child instanceof THREE.Mesh) {
        //                 child.material.map = texture;
        //             }
        //         });
        //         // The code below positions the polygon model in reference to the 
		// 		// point cloud coordinate system. In this case the units are in meters and radians.
		// 		object.position.set(-12.61, 44.05, 3.98 );
		// 		object.scale.multiplyScalar(.24);
		// 		object.rotation.set(Math.PI / 2, Math.PI / 1.45, 0 );


        //         viewer.scene.scene.add(object);

        //         viewer.onGUILoaded(() => {
        //             // Add entries to object list in sidebar
        //             let tree = $(`#jstree_scene`);
        //             let parentNode = "other";

        //             let meshID = tree.jstree('create_node', parentNode, {
        //                 text: "St John the Evangelist",
        //                 icon: `${Potree.resourcePath}/icons/triangle.svg`,
        //                 data: object
        //             },
        //                 "last", false, false);
        //             tree.jstree(object.visible ? "check_node" : "uncheck_node", meshID);

        //             //tree.jstree("open_node", parentNode); 
        //         });
        //         viewer.scene.addAnnotation([-12.653, 44.137, 2.434], {
		// 				    "cameraPosition": [-15.589, 46.246, 4.300],
		// 				    "cameraTarget": [-15.195, 45.827, 4.256],
		// 				    "title": "St John the Evangelist",
        //                     "description": `<div style="overflow:scroll ; height:350px">Giovanni del Biondo, John the Evangelist, ca. 1380<br/><br/>Orsanmichele<br/><br/>Silk Guild 
		// 					<br/><br/>
		// 					<br/><br/>
		// 					Giovanni del Biondo 
		// 					<br/><br/>
		// 					Active in Florence from ca. 1360 until his death in 1396, Giovanni del Biondo’s prolific career spanned most of the last half of the fourteenth century. Trained as a fresco painter but also active as a miniaturist, the artist’s most frequent type of commission came in the form of panel pictures for liturgical settings. The facial characteristics of his figures frequently feature large eyes, jutting jawlines, and rosy cheeks. While he understood the potency of light and shadows as signifiers of volume and space, Giovanni’s paintings rarely convey the same brilliance as do the works of his Giottesque predecessors or his Gerinesque contemporaries. Still, the preponderance of images produced by Giovanni del Biondo – whose paintings adorned spaces in the Duomo, S. Maria Novella, S. Croce, and S. Maria degli Angeli, to name but a few – suggests his popularity in Florence irrespective of the limited skill set he retained. 
		// 					<br/><br/>
		// 					Circumstances of John the Evangelist 
		// 					<br/><br/>
		// 					Commissioned by the Silk Merchants sometime near 1380, Giovanni del Biondo’s vertically oriented painting of John the Evangelist matches the type of picture installed systematically on the piers of Orsanmichele by late Trecento painters working for the different guilds of Florence. Located on the pier adjacent to Orcagna’s Tabernacle and the miracle working Madonna of Orsanmichele inside it, painted by Bernardo Daddi in 1347, the picture of the patron saint of the Por Santa Maria – the name of the Silk Guild, taken from the location of its headquarters near the city gate named for the Virgin Mary – enjoyed a position of prominence inside the church of the guilds. Its arrangement, with a tall compartment for the effigy and a smaller narrative picture below, aligns the image with typical side panels and predellas that normally flanked central compartments of polyptych altarpieces. Its proximity to Daddi’s cult image of the Madonna, installed with neither side panels nor predella scenes, suggests that the Evangelist – as well as the other pier panels inside Orsanmichele – were produced as surrogates that extended the visual presence of a typical altarpiece throughout the entire ground floor of the guild church. 
		// 					<br/><br/>
		// 					The Form of John 
		// 					<br/><br/>
		// 					The enthroned Evangelist sits with the index finger of his right hand pointed up toward the half-length image of Christ. Both figures hold opened books in their left hands: Christ’s contains the first and last letters of the Greek alphabet – the Alpha and Omega – which symbolize the beginning and the end, or the entirety of purpose that He entails, while John’s book features the opening verses of his Gospel text, “In the beginning was the Word ….” John’s symbolic eagle perches below his right elbow and an inkwell and quill pen remind us of his authoritative authorship. At his feet, as though trampled by the power of Evangelic insight, lie personifications of the three vices of Pride, Avarice, and Vanity. The narrative scene below illustrates the Ascension of John, who rises up from his earthly grave into the waiting arms of Christ, who is flanked in His Celestial Court by Peter, Paul, and (presumably) the other three Gospel writers. Clerics to the left and puzzled bystanders at the right witness the miraculous event, while the symbol of the Silk Guild – a locked gate – appears on either side of this scene in the form of two coats of arms. 
		// 					<br/><br/>
		// 					Iconography 
		// 					<br/><br/>
		// 					The frontal position of the figure, combined with his iconographic attribute and emblem of his fame, matches standard representations of figures as they appeared on altarpiece designs. Although a similar approach was taken in the design of the pier panel of St. Zenobius for the nave of the Duomo, the addition of three vices under John’s feet deviates somewhat from the normal representation of saints. Pride, or “Superbia,” has been painted as a bearded soldier, complete with silver gilt wings, helmet, and sword: the metallic materials were used by artists when rendering armed invaders or militant marauders. Vanity has been represented as a royal woman in an emerald gown and gold crown, gazing at her own reflection in a gilt mirror. Between them lies Avarice, who struggles to clutch a bag of coins pregnant with sin. The combination implies a celebration of Republican virtues, for none of the personifications – neither armed marauder, privileged princess, nor female titan – were publicly embraced by Florentines steeped in their own traditions of patriarchal, non-aristocratic, mercantilism.  
		// 					<br/><br/>
		// 					Silk Guild (Por S. Maria) 
		// 					<br/><br/>
		// 					The Silk Guild, or the Arte Por S. Maria (the guild at the gate of St. Mary), was one of the six major trade organizations of the city: among their ranks were priors, artists, and international financiers of tremendous influence. Along with the Wool guild, the Arte Por S. Maria specialized in the creation of elegant garments that gradually became the staple of the Florentine wardrobe. The designer fabrics they produced brought with them hefty profits into the guild, and by the fifteenth century Silk merchants accounted for a disproportionate number of the city’s highest earners. Their decision to pay Giovanni del Biondo for the panel to celebrate their patron saint in Orsanmichele was in keeping with the guild’s interest in maintaining a visual presence in the church: indeed, the guild had chosen to serve as caretakers of the building as early as 1336 and its members were keen to maintain it. The symbol of the Silk Guild – a locked gate – appears on either side of the narrative scene in the form of two coats of arms. `
		// 		});
        //     }, onProgress, onError);
        // }
		//Obj Mesh object ends HERE

        //OBJ Mesh Object2 Starts Here St Marten
        // {
        //     let manager = new THREE.LoadingManager();
        //     manager.onProgress = function (item, loaded, total) {
        //         console.log(item, loaded, total);
        //     };

        //     let onProgress = function (xhr) {
        //         if (xhr.lengthComputable) {
        //             let percentComplete = xhr.loaded / xhr.total * 100;
        //             console.log(Math.round(percentComplete, 2) + '% downloaded');
        //         }
        //     };
        //     let onError = function (xhr) { };
		// 	//TextureLoader points to the texture created in the photogrammetry workflow
        //     const texture = new THREE.TextureLoader().load(`${Potree.resourcePath}/textures/OSMMartin80Kb.jpg`);

        //     texture.wrapS = THREE.RepeatWrapping;
        //     texture.wrapT = THREE.RepeatWrapping;

        //     let loader = new OBJLoader(manager);
		// 	//OBJLoader loads the polygon model created in the photogrammetry workflow
        //     loader.load(`${Potree.resourcePath}/models/OSMMartin80K.obj`, function (object) {
        //         object.traverse(function (child) {
        //             if (child instanceof THREE.Mesh) {
        //                 child.material.map = texture;
        //             }
        //         });
        //         // The code below positions the polygon model in reference to the 
		// 		// point cloud coordinate system. In this case the units are in meters and radians.
				
        //         object.position.set(-25.3, 47.8, 2.68);
		// 		object.scale.multiplyScalar(1);
		// 		object.rotation.set(-.03,-.03, Math.PI/6 );


        //         viewer.scene.scene.add(object);

        //         viewer.onGUILoaded(() => {
        //             // Add entries to object list in sidebar
        //             let tree = $(`#jstree_scene`);
        //             let parentNode = "other";

        //             let meshID = tree.jstree('create_node', parentNode, {
        //                 text: "St John the Evangelist",
        //                 icon: `${Potree.resourcePath}/icons/triangle.svg`,
        //                 data: object
        //             },
        //                 "last", false, false);
        //             tree.jstree(object.visible ? "check_node" : "uncheck_node", meshID);

        //             //tree.jstree("open_node", parentNode);
        //         });
        //         viewer.scene.addAnnotation([-25.342, 47.796, 2.507], {
		// 				    "cameraPosition": [-27.915, 50.451, 4.097],
		// 				    "cameraTarget": [-18.490, 37.353, 2.530],
		// 				    "title": "St Martin",
        //                     "description":"St Martin descriptive text here",
		// 		});

        //     }, onProgress, onError);
        // }
		//Obj Mesh object ends HERE st marten

        //OBJ Mesh Object2 Starts Here Bartholomew
        // {
        //     let manager = new THREE.LoadingManager();
        //     manager.onProgress = function (item, loaded, total) {
        //         console.log(item, loaded, total);
        //     };

        //     let onProgress = function (xhr) {
        //         if (xhr.lengthComputable) {
        //             let percentComplete = xhr.loaded / xhr.total * 100;
        //             console.log(Math.round(percentComplete, 2) + '% downloaded');
        //         }
        //     };
        //     let onError = function (xhr) { };
		// 	//TextureLoader points to the texture created in the photogrammetry workflow
        //     const texture = new THREE.TextureLoader().load(`${Potree.resourcePath}/textures/BartholomewTrimBright.jpg`);

        //     texture.wrapS = THREE.RepeatWrapping;
        //     texture.wrapT = THREE.RepeatWrapping;

        //     let loader = new OBJLoader(manager);
		// 	//OBJLoader loads the polygon model created in the photogrammetry workflow
        //     loader.load(`${Potree.resourcePath}/models/BartholomewTrim.obj`, function (object) {
        //         object.traverse(function (child) {
        //             if (child instanceof THREE.Mesh) {
        //                 child.material.map = texture;
        //             }
        //         });
        //         // The code below positions the polygon model in refer-10, 28.75, 2.20ence to the 
		// 		// point cloud coordinate system. In this case the units are in meters and radians.
				
        //         object.position.set(-17.75, 51.3, 3.48);
		// 		object.scale.multiplyScalar(.01);
		// 		object.rotation.set(0,-.005, -Math.PI/3.2);


        //         viewer.scene.scene.add(object);

        //         viewer.onGUILoaded(() => {
        //             // Add entries to object list in sidebar
        //             let tree = $(`#jstree_scene`);
        //             let parentNode = "other";

        //             let meshID = tree.jstree('create_node', parentNode, {
        //                 text: "St John the Evangelist",
        //                 icon: `${Potree.resourcePath}/icons/triangle.svg`,
        //                 data: object
        //             },
        //                 "last", false, false);
        //             tree.jstree(object.visible ? "check_node" : "uncheck_node", meshID);

        //             //tree.jstree("open_node", parentNode);
        //         });
        //     }, onProgress, onError);
        // }
		//Obj Mesh object ends HERE

		{ // LIGHTS. Lights can be added and adjusted to change the appearance of the polygon models.
			//const directional = new THREE.DirectionalLight( 0xffffff, .5);
			//directional.position.set( -1.503, 21.122, 6.141 );
			//directional.lookAt(-1.503, 21.122, -0.141);

            //const directional2 = new THREE.DirectionalLight( 0xffffff, .3);
			//directional2.position.set( 1.672, 27.008, 6 );
			//directional2.lookAt(2.818, 25.235, 3.432);

            

			const ambient = new THREE.AmbientLight(0xffffff,1.3);

			//viewer.scene.scene.add(directional);
            //viewer.scene.scene.add(directional2)
			viewer.scene.scene.add(ambient);
		}
        // ANNOTATION. The code below adds an annotation in the point cloud
		let PacinoTitle = $(`<span>Saints Cosmas and Damian</span>`);
        
        PacinoTitle.toString = () => "Saints Cosmas and Damian";

        let aAbout1 = new Potree.Annotation({
            // These lines define where the annotation will appear and where the user's view will be 
			// directed when the annotation is clicked.
			position: [-18.580, 38.825, 2.706],
            title: PacinoTitle,
            cameraPosition: [-16.979, 40.588, 3.994],
            cameraTarget: [-18.665, 38.920, 3.568],
            description: `<div style="overflow:scroll ; height:350px">The painting of Sts. Cosmas and Damian, currently in the North Carolina Museum of 
			Art in Raleigh, NC, features the standing figures of the two Physician saints revered by the Florentine 
			Arte dei Medici e Speziali (the Guild of Doctors and Apothecaries). Dressed in contemporary garments 
			worn at the time by its members (accentuated by white elements of Ermine fur at the hem and collar), 
			Cosmas and Damian hold holy manuscripts as they receive a blessing from Christ above. The two predella
			scenes at the dossal s base recount their miraculous transplant of a wounded leg (whereby the limb of a 
			Caucasian patient was replaced with that of a recently deceased African) and the decapitation of both saints. 
			<br/><br/>
			The painting has been attributed to Matteo di Pacino, a Florentine painter of note who worked between ca. 
			1360 and 1375 and participated in important projects in the city: he was named in 1371 as a participant in
			the production of the Coronation of the Virgin for the nunnery of S. Pier Maggiore (now in London), probably 
			painted frescoes a few years later in the Rinuccini Chapel of S. Croce s Sacristy, and most likely produced
			miniatures in at least two choral books used by the Franciscans there. 
			<br/><br/>
			No archival references address the dossal painting of Sts. Cosmas and Damian. Based on its stylistic features, 
			the panel should probably be dated to the early years of the 1370s, while its subject matter, dimensions, and 
			format suggest that it was originally placed on one of the piers in the guild church of Orsanmichele. There it 
			would have been seen alongside other similarly shaped representations of guild patron saints, like the St. Matthew 
			Triptych by Andrea and Jacopo di Cione from 1369 (Florence, Uffizi), St. John the Evangelist by Giovanni del Biondo 
			(Florence, Accademia), and St. Bartholomew by Jacopo del Casentino (Florence, Accademia). These, in turn, 
			surrounded Andrea di CIone s massive tabernacle containing Bernardo Daddi s miracle working cult image of 1347 
			called the Madonna of Orsanmichele. 
`
        });
		
		
		
		
		
		{
			let lastAnnotations = {};
			async function fetchAnnotations() {
				try {
					const response = await fetch('annotationOrsanmichele.txt?v=*');
					if (response.ok) {
						const data = await response.text();
						
						console.log(data);
						
						
						let pageTitle, location, blockName, annotationDetails, cameraPosition, cameraTarget = '';
						const annoData = [];
						const url = 'annotationOrsanmichele.txt?v=*';
                        
						const sections = data.split(/\\\\+/); // Split based on the line of slashes

                        sections.forEach(section => {
                          const lines = section.split('\n');

                          // Reset variables for each section
                          pageTitle = location = blockName = annotationDetails = cameraPosition = cameraTarget = '';

                          // Parse each line
                          lines.forEach(line => {
                            if (line.startsWith('Page:')) {
                              pageTitle = line.replace('Page:', '').trim();
                            } else if (line.startsWith('Location of Annotation:')) {
                              location = line.replace('Location of Annotation:', '').trim();
                            } else if (line.startsWith('Camera Location:')) {
                              cameraPosition = line.replace('Camera Location:', '').trim();
                            } else if (line.startsWith('Camera Looks Towards:')) {
                              cameraTarget = line.replace('Camera Looks Towards:', '').trim();
                            } else if (line.startsWith('Annotation block name:')) {
                              blockName = line.replace('Annotation block name:', '').trim();
                            } else if (line.startsWith('Annotation Details:')) {
                              annotationDetails = line.replace('Annotation Details:', '').trim();
                            } else {
                              // If it's not a key line, add to annotation details
                              if (annotationDetails) {
                                annotationDetails += `<p>${line.trim()}</p>`;
                              }
                            }
                          });
                          console.log(pageTitle);
                          // Check if we have a valid title and location
                          if (pageTitle && location) {

                            location = location.split(",").map(value => parseFloat(value.trim()));
                            cameraPosition = cameraPosition.split(",").map(value => parseFloat(value.trim()));
                            cameraTarget = cameraTarget.split(",").map(value => parseFloat(value.trim()));

                            const currentUrl = window.location.href;


                            // Only process if the current URL matches the page title
                            if (currentUrl === pageTitle) {
                              console.log(currentUrl, pageTitle);
                              if (!lastAnnotations[blockName]) {
                                  lastAnnotations[blockName] = {
                                      location,
                                      cameraPosition,
                                      cameraTarget,
                                      annotationDetails
                                  };

                                  // Process the data and create the annotation (using Potree in your case)
                                  processData(pageTitle, location, cameraPosition, cameraTarget, blockName, annotationDetails);
                              }
//                              processData(pageTitle, location, cameraPosition, cameraTarget, blockName, annotationDetails);
                            }
                          }
                        });
						
						
						function processData(title) {
							let autoAnnos = new Potree.Annotation({
								position: location,
								"cameraPosition": cameraPosition,
								"cameraTarget": cameraTarget,
								"title": blockName,
								"description": annotationDetails
							});
							viewer.scene.annotations.add(autoAnnos);
							console.log("Processing data:");
						}	
					} else {
						console.error('fail to load annotations');
					}
				} catch (error) {
					console.error('Error fetching annotation:', error);
				}
			}
			setInterval(fetchAnnotations, 5000);
			
			fetchAnnotations();
		}
		
		
//		{
//            let pageTitle, location, blockName, annotationDetails, cameraPosition, cameraTarget = '';
//            const annoData = [];
//            const url = 'annotationOrsanmichele.txt?v=*';
//			
//			
//            fetch(url)
//              .then((res) => res.text())
//              .then((text) => {
//                const sections = text.split(/\\\\+/); // Split based on the line of slashes
//
//                sections.forEach(section => {
//                  const lines = section.split('\n');
//
//                  // Reset variables for each section
//                  pageTitle = location = blockName = annotationDetails = cameraPosition = cameraTarget = '';
//
//                  // Parse each line
//                  lines.forEach(line => {
//                    if (line.startsWith('Page:')) {
//                      pageTitle = line.replace('Page:', '').trim();
//                    } else if (line.startsWith('Location of Annotation:')) {
//                      location = line.replace('Location of Annotation:', '').trim();
//                    } else if (line.startsWith('Camera Location:')) {
//                      cameraPosition = line.replace('Camera Location:', '').trim();
//                    } else if (line.startsWith('Camera Looks Towards:')) {
//                      cameraTarget = line.replace('Camera Looks Towards:', '').trim();
//                    } else if (line.startsWith('Annotation block name:')) {
//                      blockName = line.replace('Annotation block name:', '').trim();
//                    } else if (line.startsWith('Annotation Details:')) {
//                      annotationDetails = line.replace('Annotation Details:', '').trim();
//                    } else {
//                      // If it's not a key line, add to annotation details
//                      if (annotationDetails) {
//                        annotationDetails += `<p>${line.trim()}</p>`;
//                      }
//                    }
//                  });
//                  console.log(pageTitle);
//                  // Check if we have a valid title and location
//                  if (pageTitle && location) {
//
//                    location = location.split(",").map(value => parseFloat(value.trim()));
//                    cameraPosition = cameraPosition.split(",").map(value => parseFloat(value.trim()));
//                    cameraTarget = cameraTarget.split(",").map(value => parseFloat(value.trim()));
//
//                    const currentUrl = window.location.href;
//
//
//                    // Only process if the current URL matches the page title
//                    if (currentUrl === pageTitle) {
//                      console.log(currentUrl, pageTitle);
//                      processData(pageTitle, location, cameraPosition, cameraTarget, blockName, annotationDetails);
//                    }
//                  }
//                });
//              })
//              .catch((e) => console.error(e));

//            function processData(title) {
//                let autoAnnos = new Potree.Annotation({
//                    position: location,
//                    "cameraPosition": cameraPosition,
//                    "cameraTarget": cameraTarget,
//                    "title": blockName,
//                    "description": annotationDetails
//                });
//                viewer.scene.annotations.add(autoAnnos);
//                console.log("Processing data:");
//            }	
//        }
		
		
		
        viewer.scene.annotations.add(aAbout1);
		//end annnotation
		
		var supportsWheel = false;
		var annotations =  viewer.scene.getAnnotations(); 
		const MinDistanceFromPainting = 5;
		
		/* The function that will run when the events are triggered. */
		function HideAnnotations (e) {
			/* Check whether the wheel event is supported. */
			if (e.type == "wheel") supportsWheel = true;
			else if (e.key === 'w' || e.key === 'a' || e.key === 's' || e.key === 'd') supportsWheel =  true;
			else if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') supportsWheel =  true;
			else if (supportsWheel) return;
				
	
			if (annotations && annotations.children) {
					annotations.children.forEach(function(anno) {
					if (anno.position) {
						if (anno.title) {
							if (Math.sqrt(((viewer.scene.getActiveCamera().position.x) - (anno.position.x))**2  +
									      ((viewer.scene.getActiveCamera().position.y) - (anno.position.y))**2 +
										  ((viewer.scene.getActiveCamera().position.z) - (anno.position.z))**2) < MinDistanceFromPainting) {
								anno.visible = true;
							} else {
								anno.visible = false;
							}
						}
					}
				});
			}
				
				
		}
		/* Add the event listeners for each event. */
		document.addEventListener('wheel', HideAnnotations);
		document.addEventListener('keydown', HideAnnotations);
		document.addEventListener('DOMMouseScroll', HideAnnotations);
	</script>
	
	
  </body>
</html>
